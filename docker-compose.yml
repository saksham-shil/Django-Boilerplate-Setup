services:
  db:
    image: "postgres:alpine"
    environment:
      - POSTGRES_USER={{ project_name }}
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB={{ project_name }}
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    volumes:
      - dbdata:/var/lib/postgresql/data:delegated
    restart: unless-stopped

  broker:
    image: "rabbitmq:alpine"
    ports:
      - "127.0.0.1:${RABBITMQ_PORT:-5672}:5672"
    restart: unless-stopped

  result:
    image: "redis:alpine"
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-your_redis_password_here}
    restart: unless-stopped

  backend:
    build:
      dockerfile: backend/Dockerfile
      context: .
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ./:/home/user/app/
    env_file: backend/.env
    depends_on:
      - db
      - broker
      - result
    restart: unless-stopped

  celery:
    build:
      dockerfile: backend/Dockerfile
      context: .
    command: celery --app={{ project_name }} worker --loglevel=info
    volumes:
      - ./:/home/user/app/
    env_file: backend/.env
    depends_on:
      - db
      - broker
      - result
    restart: unless-stopped

volumes:
  dbdata:
    name: {{ project_name }}_dbdata
    external: true
